trigger:
  branches:
    include:
      - main
      - develop

variables:
  AZURE_LOCATION: eastus
  
  # RM e Nomes dos Recursos (ALTERE O RM PARA O SEU)
  RM: "557074"  # <<< TROQUE PELO SEU RM
  RESOURCE_GROUP: rg-vroom-rm$(RM)
  ACR_NAME: acrvroomrm$(RM)
  ACR_LOGIN_SERVER: acrvroomrm$(RM).azurecr.io
  
  # Container Images
  APP_IMAGE_NAME: appvroom
  DB_IMAGE_NAME: postgres
  APP_TAG: latest
  DB_TAG: 17-alpine
  
  # Container Instances
  ACI_DB_NAME: aci-db-vroom-rm$(RM)
  ACI_APP_NAME: aci-app-vroom-rm$(RM)
  
  # Database Configuration
  DB_NAME: mydatabase
  DB_USER: myuser
  DB_PASSWORD: secret
  SPRING_DATASOURCE_URL: jdbc:postgresql://aci-db-vroom-rm557074.eastus.azurecontainer.io:5432/$DB_NAME
  
  # Azure Service Connection
  azureSubscription: AzureVroom

stages:
  # Deploy Application
  - stage: DeployApp
    displayName: 'Deploy Application'
    jobs:
      - job: DeployApp
        displayName: 'Deploy AplicaÃ§Ã£o no ACI'
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: none

          - task: AzureCLI@2
            displayName: 'Deploy Application Container'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -euo pipefail
                
                echo "Using resource group: $(RESOURCE_GROUP) in $(AZURE_LOCATION)"
                
                # Obter credenciais do ACR
                echo "ðŸ”‘ Obtendo credenciais do ACR..."
                ACR_USERNAME=$(az acr credential show -n $(ACR_NAME) --query username -o tsv)
                ACR_PASSWORD=$(az acr credential show -n $(ACR_NAME) --query "passwords[0].value" -o tsv)
                
                # Obter FQDN do banco
                DB_FQDN=$(az container show --resource-group $(RESOURCE_GROUP) --name $(ACI_DB_NAME) --query ipAddress.fqdn -o tsv)
                echo "ðŸ“ Usando banco de dados: $DB_FQDN"
                
                # Nome do container e DNS
                APP_CONTAINER_NAME="$(ACI_APP_NAME)"
                APP_DNS_LABEL="$(ACI_APP_NAME)"
                
                # Excluir container anterior
                echo "ðŸ—‘ï¸ Limpando container anterior se existir..."
                az container delete --resource-group $(RESOURCE_GROUP) --name "$APP_CONTAINER_NAME" --yes || true
                sleep 10
                
                # Deploy da aplicaÃ§Ã£o
                APP_IMAGE="$(ACR_LOGIN_SERVER)/$(APP_IMAGE_NAME):$(APP_TAG)"
                echo "ðŸš€ Criando container da aplicaÃ§Ã£o no ACI..."
                echo "Imagem: $APP_IMAGE"
                
                az container create \
                  --resource-group $(RESOURCE_GROUP) \
                  --name "$APP_CONTAINER_NAME" \
                  --image "$APP_IMAGE" \
                  --cpu 2 --memory 3 \
                  --registry-login-server $(ACR_LOGIN_SERVER) \
                  --registry-username "$ACR_USERNAME" \
                  --registry-password "$ACR_PASSWORD" \
                  --environment-variables \
                    SPRING_DATASOURCE_URL="jdbc:postgresql://$DB_FQDN:5432/$(DB_NAME)" \
                    SPRING_DATASOURCE_USERNAME=$(DB_USER) \
                    SPRING_DATASOURCE_PASSWORD=$(DB_PASSWORD) \
                    SPRING_JPA_HIBERNATE_DDL_AUTO=update \
                    SPRING_FLYWAY_URL="jdbc:postgresql://$DB_FQDN:5432/$(DB_NAME)" \
                    SPRING_FLYWAY_USER=$(DB_USER) \
                    SPRING_FLYWAY_PASSWORD=$(DB_PASSWORD) \
                  --ports 8080 \
                  --os-type Linux \
                  --dns-name-label "$APP_DNS_LABEL" \
                  --location $(AZURE_LOCATION) \
                  --restart-policy always
                
                APP_URL="http://$APP_DNS_LABEL.$(AZURE_LOCATION).azurecontainer.io:8080"
                echo "âœ… Application deployed at: $APP_URL"

