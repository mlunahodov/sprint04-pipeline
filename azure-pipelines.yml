  trigger:
    - main

  variables:
    GRADLE_USER_HOME: $(Pipeline.Workspace)/.gradle
    AZURE_LOCATION: eastus
    RESOURCE_GROUP: rg-vroom-rm557074
    ACR_NAME: acrvroomrm557074
    ACR_LOGIN_SERVER: acrvroomrm557074.azurecr.io
    IMAGE_NAME: appvroom
    IMAGE_TAG: latest
    RM: "557074"
    azureSubscription: AzureVroom
    DB_NAME: mydatabase
    DB_USER: myuser
    SPRING_DATASOURCE_URL: jdbc:postgresql://aci-db-vroom-rm557074.eastus.azurecontainer.io:5432/$DB_NAME
    

  stages:
    - stage: Build
      displayName: CI (build & tests)
      jobs:
        - job: gradleBuild
          pool:
            vmImage: ubuntu-latest

          steps:
            - task: Cache@2
              inputs:
                key: 'gradle | "$(Agent.OS)" | **/*.gradle*'
                restoreKeys: |
                  gradle | "$(Agent.OS)"
                  gradle
                path: $(GRADLE_USER_HOME)
              displayName: Configure gradle caching

            - task: Gradle@3
              inputs:
                gradleWrapperFile: "gradlew"
                tasks: "build"
                publishJUnitResults: true
                options: '--debug --build-cache -D"spring.profiles.active=test"'
                testResultsFiles: "**/TEST-*.xml"
                javaHomeOption: "JDKVersion"
                sonarQubeRunAnalysis: false
              env:
                SPRING_PROFILES_ACTIVE: 'test'
                SPRING_DATASOURCE_URL:""
                SPRING_FLYWAY_URL:""

            - script: ./gradlew --stop
              displayName: Gradlew stop

            - task: CopyFiles@2
              displayName: "Copy Files to artifact staging directory"
              inputs:
                SourceFolder: "$(System.DefaultWorkingDirectory)"
                Contents: "**/build/libs/*SNAPSHOT.jar"
                TargetFolder: $(Build.ArtifactStagingDirectory)

            - publish: $(Build.ArtifactStagingDirectory)
              artifact: VroomApp

        - job: BuildAndPushImage
          displayName: Build and push docker image
          pool:
            vmImage: ubuntu-latest
          dependsOn: gradleBuild
          condition: succeeded()
          steps:
            - task: Docker@2
              inputs:
                command: login
                containerRegistry: vroomservice557074
            - task: Docker@2
              inputs:
                command: buildAndPush
                repository: appvroom
                tags: |
                  latest
                  $(Build.BuildId)

    - stage: Deploy_ACI
      displayName: CD - Deploy to Azure Container Instances
      dependsOn: Build
      condition: succeeded()
      jobs:
        - job: Deploy
          displayName: Deploy App to ACI
          pool:
            vmImage: 'ubuntu-latest'
          steps:
            - checkout: none

            - task: AzureCLI@2
              displayName: 'Deploy Application to ACI'
              inputs:
                azureSubscription: '$(azureSubscription)'
                scriptType: bash
                scriptLocation: inlineScript
                inlineScript: |
                  set -euo pipefail

                  echo "Using resource group: $(RESOURCE_GROUP) in $(AZURE_LOCATION)"

                  # Obter credenciais do ACR existente
                  ACR_USERNAME=$(ACR_USERNAME)
                  ACR_PASSWORD=$(ACR_PASSWORD)

                  # Nome do container e DNS
                  APP_CONTAINER_NAME="aci-app-vroom-rm$(RM)"
                  APP_DNS_LABEL="aci-app-vroom-rm$(RM)"


                  # Excluir container anterior (para liberar DNS)
                  echo "Cleaning up previous container if it exists..."
                  az container delete --resource-group "$(RESOURCE_GROUP)" --name "$APP_CONTAINER_NAME" --yes || true
                  sleep 10

                  # Criar container da aplicação
                  APP_IMAGE="$(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(IMAGE_TAG)"
                  echo "Deploying application container: $APP_CONTAINER_NAME"

                  az container create \
                    --resource-group "$(RESOURCE_GROUP)" \
                    --name "$APP_CONTAINER_NAME" \
                    --image "$APP_IMAGE" \
                    --cpu 1 --memory 2 \
                    --registry-login-server "$(ACR_LOGIN_SERVER)" \
                    --registry-username "$ACR_USERNAME" \
                    --registry-password "$ACR_PASSWORD" \
                    --environment-variables \
                      SPRING_DATASOURCE_URL="$(SPRING_DATASOURCE_URL)" \
                      SPRING_DATASOURCE_USERNAME="$(DB_USER)" \
                      SPRING_DATASOURCE_PASSWORD="$(DB_PASSWORD)" \
                      SPRING_JPA_HIBERNATE_DDL_AUTO=update \
                      SPRING_FLYWAY_URL="$(SPRING_DATASOURCE_URL)" \
                      SPRING_FLYWAY_USER="$(DB_USER)" \
                      SPRING_FLYWAY_PASSWORD="$(DB_PASSWORD)" \
                    --ports 8080 \
                    --os-type Linux \
                    --dns-name-label "$APP_DNS_LABEL" \
                    --location "$(AZURE_LOCATION)" \
                    --restart-policy Always

                  APP_URL="http://$APP_DNS_LABEL.$(AZURE_LOCATION).azurecontainer.io:8080"
                  echo "✅ Application deployed at: $APP_URL"